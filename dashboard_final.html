
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Calidad COPC v2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <style>
        :root {
            --primary-color: #003366;
            --secondary-color: #00509E;
            --accent-color: #FFD700;
            --background-color: #f4f7fa;
            --text-color: #333;
            --card-bg: #ffffff;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: auto;
        }
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .filters {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filters > div {
            display: flex;
            flex-direction: column;
        }
        .filters label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .filters input, .filters select, .filters button {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .filters button {
            background-color: var(--secondary-color);
            color: white;
            cursor: pointer;
            border: none;
            align-self: flex-end;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 16px;
            font-weight: bold;
            color: var(--secondary-color);
        }
        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px 8px 0 0;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .grid-container {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .kpi-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        .kpi-card h3 {
            margin: 0 0 10px 0;
            color: var(--secondary-color);
        }
        .kpi-card p {
            font-size: 2.5em;
            margin: 0;
            font-weight: bold;
        }
        .chart-card, .analysis-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        .analysis-card h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }
        .analysis-card ul {
            list-style-type: none;
            padding: 0;
        }
        .analysis-card ul li {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 5px solid var(--secondary-color);
        }
        .table-container {
            overflow-x: auto;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            grid-column: 1 / -1;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: var(--secondary-color);
            color: white;
        }
        tbody tr:hover {
            background-color: #f1f1f1;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 1200px;
            border-radius: 8px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 25px;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Dashboard de Gestión de Calidad (COPC) v2</h1>
        </header>

        <div class="filters">
            <div>
                <label for="fecha-desde">Fecha Desde:</label>
                <input type="date" id="fecha-desde">
            </div>
            <div>
                <label for="fecha-hasta">Fecha Hasta:</label>
                <input type="date" id="fecha-hasta">
            </div>
            <div>
                <label for="skill-filter">Skill:</label>
                <select id="skill-filter" multiple size="3"></select>
            </div>
            <div>
                <label for="supervisor-filter">Supervisor:</label>
                <select id="supervisor-filter" multiple size="3"></select>
            </div>
            <div>
                <label for="longevidad-filter">Longevidad:</label>
                <select id="longevidad-filter" multiple size="3"></select>
            </div>
            <button id="apply-filters">Aplicar Filtros</button>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'tab-ejecutivo')">Dashboard Ejecutivo</button>
            <button class="tab-button" onclick="openTab(event, 'tab-diagnostico')">Diagnóstico y Plan de Acción</button>
            <button class="tab-button" onclick="openTab(event, 'tab-agentes')">Análisis de Agentes</button>
            <button class="tab-button" onclick="openTab(event, 'tab-otros')">Otros Análisis</button>
        </div>

        <!-- Pestaña Dashboard Ejecutivo -->
        <div id="tab-ejecutivo" class="tab-content active">
            <div class="kpi-container">
                <div class="kpi-card">
                    <h3>Nota Promedio</h3>
                    <p id="kpi-nota-promedio">0</p>
                </div>
                <div class="kpi-card">
                    <h3>Total Auditorías</h3>
                    <p id="kpi-total-auditorias">0</p>
                </div>
                <div class="kpi-card">
                    <h3>% Error Crítico</h3>
                    <p id="kpi-error-critico">0%</p>
                </div>
            </div>
            <div class="grid-container">
                <div class="chart-card">
                    <canvas id="tendencia-semanal-chart"></canvas>
                </div>
                <div class="chart-card">
                    <canvas id="desempeno-skill-chart"></canvas>
                </div>
                 <div class="chart-card" style="grid-column: 1 / -1;">
                    <canvas id="causas-raiz-chart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Pestaña Diagnóstico y Plan de Acción -->
        <div id="tab-diagnostico" class="tab-content">
            <div class="grid-container">
                <div class="analysis-card">
                    <h3>Diagnóstico Ejecutivo</h3>
                    <p id="diag-ejecutivo-text"></p>
                </div>
                <div class="analysis-card">
                    <h3>Análisis y Recomendaciones COPC</h3>
                    <p id="diag-copc-text"></p>
                </div>
                <div class="analysis-card" style="grid-column: 1 / -1;">
                    <h3>Plan de Acción Inmediato</h3>
                    <ul id="plan-accion-list"></ul>
                </div>
            </div>
        </div>

        <!-- Pestaña Análisis de Agentes -->
        <div id="tab-agentes" class="tab-content">
            <div class="grid-container">
                 <div class="chart-card" style="grid-column: 1 / -1;">
                    <canvas id="cuadrante-agentes-chart"></canvas>
                </div>
            </div>
            <div class="table-container" style="margin-top: 20px;">
                <h3>Ranking de Agentes</h3>
                <table id="tabla-agentes">
                    <thead>
                        <tr>
                            <th>Agente</th>
                            <th>Supervisor</th>
                            <th>Skill</th>
                            <th>Nota Promedio</th>
                            <th>Auditorías</th>
                            <th>Errores Críticos</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Pestaña Otros Análisis -->
        <div id="tab-otros" class="tab-content">
            <div class="grid-container">
                <div class="chart-card">
                    <canvas id="desempeno-longevidad-chart"></canvas>
                </div>
                <div class="chart-card">
                    <canvas id="desempeno-supervisor-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Drill-Down -->
    <div id="drill-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 id="modal-title">Detalle de Datos</h2>
            <div class="table-container">
                <table id="modal-table">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
let fullData = {};
let charts = {};

document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('data.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        fullData = await response.json();
        console.log("Datos cargados:", fullData);
        
        populateFilters();
        initializeDashboard();

    } catch (error) {
        console.error("Error al cargar data.json:", error);
        alert("No se pudo cargar el archivo de datos 'data.json'. Por favor, asegúrese de que el archivo exista y sea accesible.");
    }

    document.getElementById('apply-filters').addEventListener('click', applyFilters);
});

function populateFilters() {
    const { skills, supervisores, longevidad, min_fecha, max_fecha } = fullData.filtros;
    
    populateSelect('skill-filter', skills);
    populateSelect('supervisor-filter', supervisores);
    populateSelect('longevidad-filter', longevidad);

    document.getElementById('fecha-desde').value = min_fecha;
    document.getElementById('fecha-hasta').value = max_fecha;
}

function populateSelect(elementId, options) {
    const select = document.getElementById(elementId);
    select.innerHTML = '';
    options.sort().forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
    });
}

function initializeDashboard() {
    updateDashboard(fullData);
}

function applyFilters() {
    const fechaDesde = document.getElementById('fecha-desde').value;
    const fechaHasta = document.getElementById('fecha-hasta').value;
    const skills = getSelectedOptions('skill-filter');
    const supervisores = getSelectedOptions('supervisor-filter');
    const longevidad = getSelectedOptions('longevidad-filter');

    const filteredRawData = fullData.datos_crudos.filter(d => {
        const fechaValida = d.Fecha >= fechaDesde && d.Fecha <= fechaHasta;
        const skillValido = skills.length === 0 || skills.includes(d.Skill);
        const supervisorValido = supervisores.length === 0 || supervisores.includes(d.Supervisor);
        const longevidadValida = longevidad.length === 0 || longevidad.includes(d.Longevidad);
        return fechaValida && skillValido && supervisorValido && longevidadValida;
    });

    const filteredAggregates = recalculateAggregates(filteredRawData);
    updateDashboard(filteredAggregates);
}

function getSelectedOptions(elementId) {
    return Array.from(document.getElementById(elementId).selectedOptions).map(opt => opt.value);
}

function recalculateAggregates(data) {
    const total_auditorias = data.length;
    const nota_promedio = total_auditorias > 0 ? data.reduce((sum, d) => sum + d.Nota, 0) / total_auditorias : 0;
    const total_errores_criticos = data.filter(d => d.Error_Critico === 'SI').length;
    const porc_errores_criticos = total_auditorias > 0 ? (total_errores_criticos / total_auditorias) * 100 : 0;

    const kpis = {
        total_auditorias,
        nota_promedio: parseFloat(nota_promedio.toFixed(2)),
        porc_errores_criticos: parseFloat(porc_errores_criticos.toFixed(2))
    };

    const groupBy = (data, key) => data.reduce((acc, item) => {
        (acc[item[key]] = acc[item[key]] || []).push(item);
        return acc;
    }, {});

    const calculateGroupStats = (groupedData, nameKey) => Object.entries(groupedData).map(([key, values]) => ({
        [nameKey]: key,
        Nota_Promedio: values.reduce((sum, v) => sum + v.Nota, 0) / values.length,
        Auditorias: values.length,
        Errores_Criticos: values.filter(v => v.Error_Critico === 'SI').length
    }));
    
    const df_temp = data.map(d => ({...d, Semana: pd.to_datetime(d.Fecha).to_period('W').start_time.strftime('%Y-%m-%d')}));
    const tendencia_semanal = calculateGroupStats(groupBy(df_temp, 'Semana'), 'Semana');

    const all_causas = data.flatMap(d => d.Causas_Raiz);
    const causas_raiz_freq = all_causas.reduce((acc, causa) => {
        acc[causa] = (acc[causa] || 0) + 1;
        return acc;
    }, {});

    return {
        kpis,
        tendencia_semanal,
        desempeno_skill: calculateGroupStats(groupBy(data, 'Skill'), 'Skill'),
        desempeno_agente: calculateGroupStats(groupBy(data, 'Agente'), 'Agente'),
        desempeno_supervisor: calculateGroupStats(groupBy(data, 'Supervisor'), 'Supervisor'),
        desempeno_longevidad: calculateGroupStats(groupBy(data, 'Longevidad'), 'Longevidad'),
        causas_raiz_freq,
        agent_quadrant_metrics: {
            avg_nota: nota_promedio,
            avg_auditorias: total_auditorias > 0 ? total_auditorias / Object.keys(groupBy(data, 'Agente')).length : 0
        },
        datos_crudos: data
    };
}

function updateDashboard(data) {
    updateKPIs(data.kpis);
    updateCharts(data);
    updateAgentTable(data.desempeno_agente, data.datos_crudos);
    updateDiagnostics(data);
}

function updateKPIs(kpis) {
    document.getElementById('kpi-nota-promedio').textContent = kpis.nota_promedio.toFixed(2);
    document.getElementById('kpi-total-auditorias').textContent = kpis.total_auditorias;
    document.getElementById('kpi-error-critico').textContent = `${kpis.porc_errores_criticos.toFixed(2)}%`;
}

function updateCharts(data) {
    // Tendencia Semanal
    createOrUpdateChart('tendencia-semanal-chart', 'line', {
        labels: data.tendencia_semanal.map(d => d.Semana).sort(),
        datasets: [{
            label: 'Nota Promedio Semanal',
            data: data.tendencia_semanal.sort((a,b) => new Date(a.Semana) - new Date(b.Semana)).map(d => d.Nota_Promedio),
            borderColor: 'rgba(0, 80, 158, 1)',
            tension: 0.1
        }]
    }, 'Tendencia de Calidad Semanal', data.datos_crudos, 'Semana');

    // Desempeño por Skill
    createOrUpdateChart('desempeno-skill-chart', 'bar', {
        labels: data.desempeno_skill.map(d => d.Skill),
        datasets: [{
            label: 'Nota Promedio',
            data: data.desempeno_skill.map(d => d.Nota_Promedio),
            backgroundColor: 'rgba(0, 51, 102, 0.7)'
        }]
    }, 'Desempeño por Línea de Negocio (Skill)', data.datos_crudos, 'Skill');

    // Pareto de Causas Raíz
    const causasData = Object.entries(data.causas_raiz_freq).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const totalCausas = causasData.reduce((sum, item) => sum + item[1], 0);
    let cumulative = 0;
    const cumulativePercentage = causasData.map(item => {
        cumulative += item[1];
        return (cumulative / totalCausas) * 100;
    });
    createOrUpdateChart('causas-raiz-chart', 'bar', {
        labels: causasData.map(d => d[0]),
        datasets: [{
            label: 'Frecuencia',
            data: causasData.map(d => d[1]),
            backgroundColor: 'rgba(255, 99, 132, 0.7)',
            yAxisID: 'y'
        }, {
            label: '% Acumulado',
            data: cumulativePercentage,
            type: 'line',
            borderColor: 'rgba(0, 51, 102, 1)',
            backgroundColor: 'transparent',
            yAxisID: 'y1'
        }]
    }, 'Análisis de Atributos de Falla (Pareto)', data.datos_crudos, 'Causas_Raiz', {
        y: { type: 'linear', position: 'left', title: { display: true, text: 'Frecuencia' } },
        y1: { type: 'linear', position: 'right', min: 0, max: 100, title: { display: true, text: '% Acumulado' }, grid: { drawOnChartArea: false } }
    });

    // Cuadrante de Agentes
    const { avg_nota, avg_auditorias } = data.agent_quadrant_metrics;
    createOrUpdateChart('cuadrante-agentes-chart', 'scatter', {
        datasets: [{
            label: 'Agentes',
            data: data.desempeno_agente.map(agente => ({
                x: agente.Auditorias,
                y: agente.Nota_Promedio,
                label: agente.Agente
            })),
            backgroundColor: 'rgba(0, 80, 158, 0.7)'
        }]
    }, 'Cuadrante de Desempeño de Agentes', data.datos_crudos, 'Agente', {
        x: { title: { display: true, text: 'Cantidad de Auditorías' } },
        y: { title: { display: true, text: 'Nota Promedio' } }
    }, {
        lineX: { type: 'line', xMin: avg_auditorias, xMax: avg_auditorias, borderColor: 'red', borderWidth: 2, label: { content: 'Prom. Auditorías', enabled: true } },
        lineY: { type: 'line', yMin: avg_nota, yMax: avg_nota, borderColor: 'red', borderWidth: 2, label: { content: 'Prom. Nota', enabled: true } },
        label1: { type: 'label', xValue: avg_auditorias * 1.5, yValue: avg_nota * 1.01, content: 'Top Performers', font: { size: 16 }, color: 'green' },
        label2: { type: 'label', xValue: avg_auditorias * 0.5, yValue: avg_nota * 1.01, content: 'Potencial', font: { size: 16 }, color: 'blue' },
        label3: { type: 'label', xValue: avg_auditorias * 0.5, yValue: avg_nota * 0.99, content: 'Coaching Urgente', font: { size: 16 }, color: 'orange' },
        label4: { type: 'label', xValue: avg_auditorias * 1.5, yValue: avg_nota * 0.99, content: 'Veteranos con Oportunidad', font: { size: 16 }, color: 'purple' }
    });

    // Otros Análisis
    createOrUpdateChart('desempeno-longevidad-chart', 'bar', {
        labels: data.desempeno_longevidad.map(d => d.Longevidad),
        datasets: [{ label: 'Nota Promedio', data: data.desempeno_longevidad.map(d => d.Nota_Promedio), backgroundColor: 'rgba(0, 80, 158, 0.7)' }]
    }, 'Desempeño por Longevidad', data.datos_crudos, 'Longevidad');
    createOrUpdateChart('desempeno-supervisor-chart', 'bar', {
        labels: data.desempeno_supervisor.map(d => d.Supervisor),
        datasets: [{ label: 'Nota Promedio', data: data.desempeno_supervisor.map(d => d.Nota_Promedio), backgroundColor: 'rgba(0, 51, 102, 0.7)' }]
    }, 'Desempeño por Supervisor', data.datos_crudos, 'Supervisor');
}

function updateAgentTable(agentes, rawData) {
    const tableBody = document.getElementById('tabla-agentes').querySelector('tbody');
    tableBody.innerHTML = '';
    agentes.sort((a, b) => b.Nota_Promedio - a.Nota_Promedio);
    agentes.forEach(agente => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${agente.Agente}</td>
            <td>${agente.Supervisor || 'N/A'}</td>
            <td>${agente.Skill || 'N/A'}</td>
            <td>${agente.Nota_Promedio.toFixed(2)}</td>
            <td>${agente.Auditorias}</td>
            <td>${agente.Errores_Criticos}</td>
        `;
        row.addEventListener('dblclick', () => {
            const agentData = rawData.filter(d => d.Agente === agente.Agente);
            showModalWithData(`Ficha de Calidad: ${agente.Agente}`, agentData);
        });
        tableBody.appendChild(row);
    });
}

function updateDiagnostics(data) {
    const { kpis, desempeno_skill, causas_raiz_freq } = data;
    const top_skill = desempeno_skill.reduce((max, s) => s.Nota_Promedio > max.Nota_Promedio ? s : max, {Nota_Promedio: 0});
    const bottom_skill = desempeno_skill.reduce((min, s) => s.Nota_Promedio < min.Nota_Promedio ? s : min, {Nota_Promedio: 101});
    const top_causa = Object.entries(causas_raiz_freq).sort((a, b) => b[1] - a[1])[0] || ['N/A', 0];

    // Diagnóstico Ejecutivo
    document.getElementById('diag-ejecutivo-text').innerText = `
        En el período analizado, se realizaron ${kpis.total_auditorias} auditorías, obteniendo una nota promedio de ${kpis.nota_promedio.toFixed(2)}. 
        El porcentaje de errores críticos es del ${kpis.porc_errores_criticos.toFixed(2)}%, un indicador clave de riesgo en la operación.
        La línea de negocio con mejor desempeño es '${top_skill.Skill}' (${top_skill.Nota_Promedio.toFixed(2)}), mientras que '${bottom_skill.Skill}' (${bottom_skill.Nota_Promedio.toFixed(2)}) presenta la mayor área de oportunidad.
        La principal causa de falla detectada es '${top_causa[0]}', con ${top_causa[1]} incidencias.
    `;

    // Análisis COPC
    document.getElementById('diag-copc-text').innerText = `
        Desde la perspectiva COPC, la variabilidad en el desempeño entre skills ('${top_skill.Skill}' vs '${bottom_skill.Skill}') sugiere una inconsistencia en la ejecución de procesos o en la efectividad del coaching.
        El ${kpis.porc_errores_criticos.toFixed(2)}% de Errores Críticos Fatales (FCEs) impacta directamente la satisfacción del cliente y la eficiencia del negocio. Es imperativo analizar la causa raíz de estos FCEs.
        Se recomienda un análisis profundo (drill-down) en los agentes y supervisores del skill '${bottom_skill.Skill}' para identificar las causas específicas de la baja performance.
    `;

    // Plan de Acción
    const planList = document.getElementById('plan-accion-list');
    planList.innerHTML = `
        <li><strong>Acción Inmediata:</strong> Iniciar sesiones de calibración con todos los auditores enfocadas en el atributo '${top_causa[0]}' para asegurar consistencia en la evaluación.</li>
        <li><strong>Coaching de Emergencia:</strong> Implementar sesiones de coaching 1-a-1 con los 5 agentes con la nota más baja dentro del skill '${bottom_skill.Skill}'.</li>
        <li><strong>Revisión de Procesos:</strong> Formar un grupo de trabajo con supervisores de '${bottom_skill.Skill}' para revisar y reforzar el proceso o conocimiento asociado a '${top_causa[0]}'.</li>
        <li><strong>Reconocimiento:</strong> Reconocer públicamente a los 'Top Performers' del cuadrante de desempeño para motivar y compartir mejores prácticas.</li>
    `;
}


function createOrUpdateChart(canvasId, type, data, title, rawData, filterKey, customScales = {}, annotations = {}) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (charts[canvasId]) {
        charts[canvasId].destroy();
    }
    charts[canvasId] = new Chart(ctx, {
        type: type,
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: title, font: { size: 18 } },
                tooltip: { callbacks: { label: (context) => type === 'scatter' ? context.raw.label : `${context.dataset.label}: ${context.formattedValue}` } },
                annotation: { annotations }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const chart = elements[0].chart;
                    const elementIndex = elements[0].index;
                    const clickedLabel = chart.data.labels[elementIndex];
                    const filtered = rawData.filter(d => Array.isArray(d[filterKey]) ? d[filterKey].includes(clickedLabel) : d[filterKey] == clickedLabel);
                    showModalWithData(clickedLabel, filtered);
                }
            },
            scales: customScales
        }
    });
}

function showModalWithData(title, data) {
    const modal = document.getElementById('drill-modal');
    document.getElementById('modal-title').textContent = title;
    const tableHead = modal.querySelector('thead');
    const tableBody = modal.querySelector('tbody');
    tableHead.innerHTML = '';
    tableBody.innerHTML = '';

    if (data.length > 0) {
        const headers = Object.keys(data[0]);
        const headerRow = document.createElement('tr');
        headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; headerRow.appendChild(th); });
        tableHead.appendChild(headerRow);

        data.forEach(item => {
            const row = document.createElement('tr');
            headers.forEach(h => {
                const td = document.createElement('td');
                let val = item[h];
                if (Array.isArray(val)) val = val.join(', ');
                else if (typeof val === 'number') val = val.toFixed(2);
                td.textContent = val;
                row.appendChild(td);
            });
            tableBody.appendChild(row);
        });
    }
    modal.style.display = 'block';
}

function closeModal() {
    document.getElementById('drill-modal').style.display = 'none';
}

function openTab(evt, tabName) {
    document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = "none");
    document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.classList.add('active');
}
</script>

</body>
</html>
