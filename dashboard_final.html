<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Calidad COPC</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        :root {
            --primary-color: #003366;
            --secondary-color: #00509E;
            --accent-color: #FFD700;
            --background-color: #f4f7fa;
            --text-color: #333;
            --card-bg: #ffffff;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: auto;
        }
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .filters {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filters > div {
            display: flex;
            flex-direction: column;
        }
        .filters label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .filters input, .filters select, .filters button {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .filters button {
            background-color: var(--secondary-color);
            color: white;
            cursor: pointer;
            border: none;
            align-self: flex-end;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 16px;
            font-weight: bold;
            color: var(--secondary-color);
        }
        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px 8px 0 0;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .grid-container {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .kpi-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        .kpi-card h3 {
            margin: 0 0 10px 0;
            color: var(--secondary-color);
        }
        .kpi-card p {
            font-size: 2.5em;
            margin: 0;
            font-weight: bold;
        }
        .chart-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        .table-container {
            overflow-x: auto;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            grid-column: 1 / -1;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: var(--secondary-color);
            color: white;
        }
        tbody tr:hover {
            background-color: #f1f1f1;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 1200px;
            border-radius: 8px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 25px;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Dashboard de Gestión de Calidad (COPC)</h1>
        </header>

        <div class="filters">
            <div>
                <label for="fecha-desde">Fecha Desde:</label>
                <input type="date" id="fecha-desde">
            </div>
            <div>
                <label for="fecha-hasta">Fecha Hasta:</label>
                <input type="date" id="fecha-hasta">
            </div>
            <div>
                <label for="skill-filter">Skill:</label>
                <select id="skill-filter" multiple></select>
            </div>
            <div>
                <label for="supervisor-filter">Supervisor:</label>
                <select id="supervisor-filter" multiple></select>
            </div>
            <div>
                <label for="longevidad-filter">Longevidad:</label>
                <select id="longevidad-filter" multiple></select>
            </div>
            <button id="apply-filters">Aplicar Filtros</button>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'tab-ejecutivo')">Dashboard Ejecutivo</button>
            <button class="tab-button" onclick="openTab(event, 'tab-agentes')">Análisis de Agentes</button>
            <button class="tab-button" onclick="openTab(event, 'tab-otros')">Otros Análisis</button>
        </div>

        <!-- Pestaña Dashboard Ejecutivo -->
        <div id="tab-ejecutivo" class="tab-content active">
            <div class="kpi-container">
                <div class="kpi-card">
                    <h3>Nota Promedio</h3>
                    <p id="kpi-nota-promedio">0</p>
                </div>
                <div class="kpi-card">
                    <h3>Total Auditorías</h3>
                    <p id="kpi-total-auditorias">0</p>
                </div>
                <div class="kpi-card">
                    <h3>% Error Crítico</h3>
                    <p id="kpi-error-critico">0%</p>
                </div>
            </div>
            <div class="grid-container">
                <div class="chart-card">
                    <canvas id="tendencia-semanal-chart"></canvas>
                </div>
                <div class="chart-card">
                    <canvas id="desempeno-skill-chart"></canvas>
                </div>
                 <div class="chart-card" style="grid-column: 1 / -1;">
                    <canvas id="causas-raiz-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Pestaña Análisis de Agentes -->
        <div id="tab-agentes" class="tab-content">
            <div class="grid-container">
                 <div class="chart-card">
                    <canvas id="cuadrante-agentes-chart"></canvas>
                </div>
            </div>
            <div class="table-container" style="margin-top: 20px;">
                <h3>Ranking de Agentes</h3>
                <table id="tabla-agentes">
                    <thead>
                        <tr>
                            <th>Agente</th>
                            <th>Supervisor</th>
                            <th>Skill</th>
                            <th>Nota Promedio</th>
                            <th>Auditorías</th>
                            <th>Errores Críticos</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Pestaña Otros Análisis -->
        <div id="tab-otros" class="tab-content">
            <div class="grid-container">
                <div class="chart-card">
                    <canvas id="desempeno-longevidad-chart"></canvas>
                </div>
                <div class="chart-card">
                    <canvas id="desempeno-supervisor-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Drill-Down -->
    <div id="drill-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 id="modal-title">Detalle de Datos</h2>
            <div class="table-container">
                <table id="modal-table">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
let fullData = {};
let charts = {};

document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('data.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        fullData = await response.json();
        console.log("Datos cargados:", fullData);
        
        populateFilters();
        initializeDashboard();

    } catch (error) {
        console.error("Error al cargar data.json:", error);
        alert("No se pudo cargar el archivo de datos 'data.json'. Por favor, asegúrese de que el archivo exista y sea accesible.");
    }

    document.getElementById('apply-filters').addEventListener('click', applyFilters);
});

function populateFilters() {
    const { skills, supervisores, longevidad, min_fecha, max_fecha } = fullData.filtros;
    
    populateSelect('skill-filter', skills);
    populateSelect('supervisor-filter', supervisores);
    populateSelect('longevidad-filter', longevidad);

    document.getElementById('fecha-desde').value = min_fecha;
    document.getElementById('fecha-hasta').value = max_fecha;
}

function populateSelect(elementId, options) {
    const select = document.getElementById(elementId);
    select.innerHTML = ''; // Limpiar opciones existentes
    options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
    });
}

function initializeDashboard() {
    updateDashboard(fullData);
}

function applyFilters() {
    const fechaDesde = document.getElementById('fecha-desde').value;
    const fechaHasta = document.getElementById('fecha-hasta').value;
    const skills = getSelectedOptions('skill-filter');
    const supervisores = getSelectedOptions('supervisor-filter');
    const longevidad = getSelectedOptions('longevidad-filter');

    const filteredRawData = fullData.datos_crudos.filter(d => {
        const fechaValida = d.Fecha >= fechaDesde && d.Fecha <= fechaHasta;
        const skillValido = skills.length === 0 || skills.includes(d.Skill);
        const supervisorValido = supervisores.length === 0 || supervisores.includes(d.Supervisor);
        const longevidadValida = longevidad.length === 0 || longevidad.includes(d.Longevidad);
        return fechaValida && skillValido && supervisorValido && longevidadValida;
    });

    const filteredAggregates = recalculateAggregates(filteredRawData);
    updateDashboard(filteredAggregates);
}

function getSelectedOptions(elementId) {
    return Array.from(document.getElementById(elementId).selectedOptions).map(opt => opt.value);
}

function recalculateAggregates(filteredData) {
    // Recalcular KPIs
    const total_auditorias = filteredData.length;
    const nota_promedio = total_auditorias > 0 ? filteredData.reduce((sum, d) => sum + d.Nota, 0) / total_auditorias : 0;
    const total_errores_criticos = filteredData.filter(d => d.Error_Critico === 'SI').length;
    const porc_errores_criticos = total_auditorias > 0 ? (total_errores_criticos / total_auditorias) * 100 : 0;

    const kpis = {
        total_auditorias,
        nota_promedio: nota_promedio.toFixed(2),
        porc_errores_criticos: porc_errores_criticos.toFixed(2)
    };

    // Agrupar datos para gráficos
    const groupBy = (data, key) => data.reduce((acc, item) => {
        (acc[item[key]] = acc[item[key]] || []).push(item);
        return acc;
    }, {});

    const calculateGroupStats = (groupedData, nameKey) => {
        return Object.entries(groupedData).map(([key, values]) => ({
            [nameKey]: key,
            Nota_Promedio: values.reduce((sum, v) => sum + v.Nota, 0) / values.length,
            Auditorias: values.length,
            Errores_Criticos: values.filter(v => v.Error_Critico === 'SI').length
        }));
    };
    
    const df_clean_temp = filteredData.map(d => ({...d, Semana: new Date(d.Fecha).toISOString().slice(0,10)}));
    const tendencia_semanal = calculateGroupStats(groupBy(df_clean_temp, 'Semana'), 'Semana');

    return {
        kpis,
        tendencia_semanal,
        desempeno_skill: calculateGroupStats(groupBy(filteredData, 'Skill'), 'Skill'),
        desempeno_agente: calculateGroupStats(groupBy(filteredData, 'Agente'), 'Agente'),
        desempeno_supervisor: calculateGroupStats(groupBy(filteredData, 'Supervisor'), 'Supervisor'),
        desempeno_longevidad: calculateGroupStats(groupBy(filteredData, 'Longevidad'), 'Longevidad'),
        causas_raiz_freq: filteredData.flatMap(d => d.Causas_Raiz).reduce((acc, causa) => {
            acc[causa] = (acc[causa] || 0) + 1;
            return acc;
        }, {}),
        datos_crudos: filteredData
    };
}


function updateDashboard(data) {
    // Actualizar KPIs
    document.getElementById('kpi-nota-promedio').textContent = data.kpis.nota_promedio;
    document.getElementById('kpi-total-auditorias').textContent = data.kpis.total_auditorias;
    document.getElementById('kpi-error-critico').textContent = `${data.kpis.porc_errores_criticos}%`;

    // Actualizar Gráficos
    createOrUpdateChart('tendencia-semanal-chart', 'line', {
        labels: data.tendencia_semanal.map(d => d.Semana),
        datasets: [{
            label: 'Nota Promedio Semanal',
            data: data.tendencia_semanal.map(d => d.Nota_Promedio),
            borderColor: 'rgba(0, 80, 158, 1)',
            tension: 0.1
        }]
    }, 'Tendencia de Calidad Semanal', data.datos_crudos, 'Semana');

    createOrUpdateChart('desempeno-skill-chart', 'bar', {
        labels: data.desempeno_skill.map(d => d.Skill),
        datasets: [{
            label: 'Nota Promedio',
            data: data.desempeno_skill.map(d => d.Nota_Promedio),
            backgroundColor: 'rgba(0, 51, 102, 0.7)'
        }]
    }, 'Desempeño por Skill', data.datos_crudos, 'Skill');
    
    const causasData = Object.entries(data.causas_raiz_freq).sort((a, b) => b[1] - a[1]).slice(0, 10);
    createOrUpdateChart('causas-raiz-chart', 'bar', {
        labels: causasData.map(d => d[0]),
        datasets: [{
            label: 'Frecuencia',
            data: causasData.map(d => d[1]),
            backgroundColor: 'rgba(255, 99, 132, 0.7)'
        }]
    }, 'Top 10 Causas Raíz de Fallas', data.datos_crudos, 'Causas_Raiz');

    createOrUpdateChart('cuadrante-agentes-chart', 'scatter', {
        datasets: [{
            label: 'Agentes',
            data: data.desempeno_agente.map(agente => ({
                x: agente.Auditorias,
                y: agente.Nota_Promedio,
                label: agente.Agente // Custom property
            })),
            backgroundColor: 'rgba(0, 80, 158, 0.7)'
        }]
    }, 'Cuadrante de Desempeño de Agentes (Volumen vs Calidad)', data.datos_crudos, 'Agente', {
        x: { title: { display: true, text: 'Cantidad de Auditorías' } },
        y: { title: { display: true, text: 'Nota Promedio' } }
    });

    createOrUpdateChart('desempeno-longevidad-chart', 'bar', {
        labels: data.desempeno_longevidad.map(d => d.Longevidad),
        datasets: [{
            label: 'Nota Promedio',
            data: data.desempeno_longevidad.map(d => d.Nota_Promedio),
            backgroundColor: 'rgba(0, 80, 158, 0.7)'
        }]
    }, 'Desempeño por Longevidad', data.datos_crudos, 'Longevidad');

    createOrUpdateChart('desempeno-supervisor-chart', 'bar', {
        labels: data.desempeno_supervisor.map(d => d.Supervisor),
        datasets: [{
            label: 'Nota Promedio',
            data: data.desempeno_supervisor.map(d => d.Nota_Promedio),
            backgroundColor: 'rgba(0, 51, 102, 0.7)'
        }]
    }, 'Desempeño por Supervisor', data.datos_crudos, 'Supervisor');

    // Actualizar Tabla de Agentes
    updateAgentTable(data.desempeno_agente, data.datos_crudos);
}

function createOrUpdateChart(canvasId, type, data, title, rawData, filterKey, customScales = {}) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (charts[canvasId]) {
        charts[canvasId].destroy();
    }
    charts[canvasId] = new Chart(ctx, {
        type: type,
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: title,
                    font: { size: 18 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (type === 'scatter') {
                                return context.raw.label;
                            }
                            return context.dataset.label + ': ' + context.formattedValue;
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const elementIndex = elements[0].index;
                    const clickedLabel = data.labels[elementIndex];
                    const filtered = rawData.filter(d => {
                        if (Array.isArray(d[filterKey])) {
                            return d[filterKey].includes(clickedLabel);
                        }
                        return d[filterKey] == clickedLabel
                    });
                    showModalWithData(clickedLabel, filtered);
                }
            },
            scales: customScales
        }
    });
}

function updateAgentTable(agentes, rawData) {
    const tableBody = document.getElementById('tabla-agentes').querySelector('tbody');
    tableBody.innerHTML = '';
    agentes.sort((a, b) => b.Nota_Promedio - a.Nota_Promedio);
    agentes.forEach(agente => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${agente.Agente}</td>
            <td>${agente.Supervisor || 'N/A'}</td>
            <td>${agente.Skill || 'N/A'}</td>
            <td>${agente.Nota_Promedio.toFixed(2)}</td>
            <td>${agente.Auditorias}</td>
            <td>${agente.Errores_Criticos}</td>
        `;
        row.addEventListener('dblclick', () => {
            const agentData = rawData.filter(d => d.Agente === agente.Agente);
            showModalWithData(`Ficha de Calidad: ${agente.Agente}`, agentData);
        });
        tableBody.appendChild(row);
    });
}

function showModalWithData(title, data) {
    const modal = document.getElementById('drill-modal');
    document.getElementById('modal-title').textContent = title;
    
    const tableHead = modal.querySelector('thead');
    const tableBody = modal.querySelector('tbody');
    tableHead.innerHTML = '';
    tableBody.innerHTML = '';

    if (data.length > 0) {
        const headers = Object.keys(data[0]);
        const headerRow = document.createElement('tr');
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        tableHead.appendChild(headerRow);

        data.forEach(item => {
            const row = document.createElement('tr');
            headers.forEach(header => {
                const td = document.createElement('td');
                let value = item[header];
                if (Array.isArray(value)) {
                    value = value.join(', ');
                } else if (typeof value === 'number') {
                    value = value.toFixed(2);
                }
                td.textContent = value;
                row.appendChild(td);
            });
            tableBody.appendChild(row);
        });
    }

    modal.style.display = 'block';
}

function closeModal() {
    document.getElementById('drill-modal').style.display = 'none';
}

function openTab(evt, tabName) {
    let i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tab-button");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}

</script>

</body>
</html>