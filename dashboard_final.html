
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Calidad COPC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .kpi-card {
            border-left: 5px solid;
            padding: 1.5rem;
        }
        .kpi-card.border-primary { border-color: #0d6efd; }
        .kpi-card.border-success { border-color: #198754; }
        .kpi-card.border-danger { border-color: #dc3545; }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .kpi-label {
            font-size: 1rem;
            color: #6c757d;
        }
        .chart-container {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
            height: 450px;
        }
        .table-responsive {
            max-height: 600px;
        }
        .nav-tabs .nav-link {
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            color: #000;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
        }
        #agent-quadrant .apexcharts-tooltip {
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1 class="mb-4">Dashboard de Gestión de Calidad</h1>

        <!-- FILTROS -->
        <div class="card mb-4">
            <div class="card-header">
                Filtros Globales
            </div>
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label for="fechaDesde" class="form-label">Fecha Desde</label>
                        <input type="date" class="form-control" id="fechaDesde">
                    </div>
                    <div class="col-md-2">
                        <label for="fechaHasta" class="form-label">Fecha Hasta</label>
                        <input type="date" class="form-control" id="fechaHasta">
                    </div>
                    <div class="col-md-3">
                        <label for="skillFilter" class="form-label">Skill</label>
                        <select id="skillFilter" class="form-select"></select>
                    </div>
                    <div class="col-md-3">
                        <label for="supervisorFilter" class="form-label">Supervisor</label>
                        <select id="supervisorFilter" class="form-select"></select>
                    </div>
                    <div class="col-md-2">
                        <button id="applyFilters" class="btn btn-primary w-100">Aplicar Filtros</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PESTAÑAS -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="executive-tab" data-bs-toggle="tab" data-bs-target="#executive" type="button" role="tab">Dashboard Ejecutivo</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="agents-tab" data-bs-toggle="tab" data-bs-target="#agents" type="button" role="tab">Análisis de Agentes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="other-tab" data-bs-toggle="tab" data-bs-target="#other" type="button" role="tab">Otros Análisis</button>
            </li>
        </ul>

        <!-- CONTENIDO DE PESTAÑAS -->
        <div class="tab-content" id="myTabContent">
            <!-- Dashboard Ejecutivo -->
            <div class="tab-pane fade show active" id="executive" role="tabpanel">
                <div class="row mt-4">
                    <!-- KPIs -->
                    <div class="col-md-4">
                        <div class="card kpi-card border-primary mb-3">
                            <div class="kpi-value" id="kpiTotalAudits">0</div>
                            <div class="kpi-label">Total Auditorías</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card kpi-card border-success mb-3">
                            <div class="kpi-value" id="kpiAvgScore">0.00</div>
                            <div class="kpi-label">Nota Promedio General</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card kpi-card border-danger mb-3">
                            <div class="kpi-value" id="kpiCriticalErrors">0.00%</div>
                            <div class="kpi-label">% Errores Críticos</div>
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-8">
                        <div class="chart-container">
                            <h5 class="card-title">Tendencia Semanal de Calidad</h5>
                            <div id="weekly-trend-chart"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="chart-container">
                            <h5 class="card-title">Pareto de Causas Raíz</h5>
                            <div id="root-cause-chart"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Análisis de Agentes -->
            <div class="tab-pane fade" id="agents" role="tabpanel">
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5 class="card-title">Cuadrante de Desempeño de Agentes</h5>
                            <div id="agent-quadrant"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Ranking de Agentes</div>
                            <div class="card-body table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Agente</th>
                                            <th>Nota Promedio</th>
                                            <th>Auditorías</th>
                                            <th>Errores Críticos</th>
                                        </tr>
                                    </thead>
                                    <tbody id="agent-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Otros Análisis -->
            <div class="tab-pane fade" id="other" role="tabpanel">
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5 class="card-title">Desempeño por Skill</h5>
                            <div id="skill-performance-chart"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5 class="card-title">Desempeño por Supervisor</h5>
                            <div id="supervisor-performance-chart"></div>
                        </div>
                    </div>
                </div>
                 <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5 class="card-title">Desempeño por Longevidad</h5>
                            <div id="longevity-performance-chart"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Drill-Down -->
    <div class="modal fade" id="drillDownModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="drillDownModalLabel">Detalle de Auditorías</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="drillDownModalBody">
                    <!-- Contenido se genera dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let fullData = {};
            let charts = {};
            const drillDownModal = new bootstrap.Modal(document.getElementById('drillDownModal'));

            // --- CARGA DE DATOS ---
            fetch('data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    fullData = data;
                    initializeApp(fullData);
                })
                .catch(error => {
                    console.error('Error al cargar data.json:', error);
                    alert('No se pudo cargar el archivo de datos (data.json). Por favor, asegúrese de que el archivo exista y sea accesible.');
                });

            // --- INICIALIZACIÓN ---
            function initializeApp(data) {
                populateFilters(data.datosCrudo);
                updateDashboard(data);
                document.getElementById('applyFilters').addEventListener('click', applyFilters);
            }

            function populateFilters(rawData) {
                const skillFilter = document.getElementById('skillFilter');
                const supervisorFilter = document.getElementById('supervisorFilter');

                const skills = [...new Set(rawData.map(item => item.Skill))].sort();
                const supervisors = [...new Set(rawData.map(item => item.Supervisor))].sort();

                skillFilter.innerHTML = '<option value="">Todos</option>' + skills.map(s => `<option value="${s}">${s}</option>`).join('');
                supervisorFilter.innerHTML = '<option value="">Todos</option>' + supervisors.map(s => `<option value="${s}">${s}</option>`).join('');
            }

            // --- LÓGICA DE FILTROS ---
            function applyFilters() {
                const filters = {
                    fechaDesde: document.getElementById('fechaDesde').value,
                    fechaHasta: document.getElementById('fechaHasta').value,
                    skill: document.getElementById('skillFilter').value,
                    supervisor: document.getElementById('supervisorFilter').value
                };

                const filteredRawData = fullData.datosCrudo.filter(item => {
                    const itemDate = new Date(item.Fecha);
                    const fechaDesde = filters.fechaDesde ? new Date(filters.fechaDesde) : null;
                    const fechaHasta = filters.fechaHasta ? new Date(filters.fechaHasta) : null;

                    if (fechaDesde && itemDate < fechaDesde) return false;
                    if (fechaHasta && itemDate > fechaHasta) return false;
                    if (filters.skill && item.Skill !== filters.skill) return false;
                    if (filters.supervisor && item.Supervisor !== filters.supervisor) return false;
                    
                    return true;
                });
                
                // Recalcular agregados a partir de la data cruda filtrada
                const filteredAggregates = recalculateAggregates(filteredRawData);
                updateDashboard(filteredAggregates);
            }
            
            function recalculateAggregates(filteredRawData) {
                // Esta es una versión simplificada. Para un dashboard complejo, 
                // sería más eficiente recalcular todo como en el script de Python.
                // Por simplicidad aquí, solo recalculamos los KPIs básicos.
                const totalAuditorias = filteredRawData.length;
                const notaPromedio = totalAuditorias > 0 ? filteredRawData.reduce((sum, item) => sum + item.Nota, 0) / totalAuditorias : 0;
                const erroresCriticos = totalAuditorias > 0 ? (filteredRawData.filter(item => item.Error_Critico === 'SI').length / totalAuditorias) * 100 : 0;

                // Para los gráficos, filtramos los datos pre-agregados para mantener la simplicidad
                // En un escenario real, se volverían a agregar desde filteredRawData
                const filteredAgents = [...new Set(filteredRawData.map(d => d.Agente))];
                const filteredSkills = [...new Set(filteredRawData.map(d => d.Skill))];
                const filteredSupervisors = [...new Set(filteredRawData.map(d => d.Supervisor))];

                return {
                    kpisGenerales: {
                        total_auditorias: totalAuditorias,
                        nota_promedio: notaPromedio,
                        porc_errores_criticos: erroresCriticos
                    },
                    // Los datos de los gráficos se filtran, no se recalculan por completo en el front
                    tendenciaSemanal: fullData.tendenciaSemanal, // La tendencia es más compleja de recalcular aquí
                    paretoCausasRaiz: fullData.paretoCausasRaiz, // El pareto también
                    desempenoAgente: fullData.desempenoAgente.filter(a => filteredAgents.includes(a.Agente)),
                    desempenoSkill: fullData.desempenoSkill.filter(s => filteredSkills.includes(s.Skill)),
                    desempenoSupervisor: fullData.desempenoSupervisor.filter(s => filteredSupervisors.includes(s.Supervisor)),
                    desempenoLongevidad: fullData.desempenoLongevidad,
                    datosCrudo: filteredRawData
                };
            }


            // --- ACTUALIZACIÓN DEL DASHBOARD ---
            function updateDashboard(data) {
                updateKPIs(data.kpisGenerales);
                renderWeeklyTrend(data.tendenciaSemanal, data.datosCrudo);
                renderRootCause(data.paretoCausasRaiz, data.datosCrudo);
                renderAgentQuadrant(data.desempenoAgente, data.datosCrudo);
                renderAgentTable(data.desempenoAgente, data.datosCrudo);
                renderSkillPerformance(data.desempenoSkill, data.datosCrudo);
                renderSupervisorPerformance(data.desempenoSupervisor, data.datosCrudo);
                renderLongevityPerformance(data.desempenoLongevidad, data.datosCrudo);
            }

            function updateKPIs(kpis) {
                document.getElementById('kpiTotalAudits').textContent = kpis.total_auditorias.toLocaleString();
                document.getElementById('kpiAvgScore').textContent = kpis.nota_promedio.toFixed(2);
                document.getElementById('kpiCriticalErrors').textContent = kpis.porc_errores_criticos.toFixed(2) + '%';
            }

            // --- FUNCIONES DE RENDERIZADO DE GRÁFICOS ---
            function renderChart(containerId, options) {
                if (charts[containerId]) {
                    charts[containerId].destroy();
                }
                const chart = new ApexCharts(document.getElementById(containerId), options);
                charts[containerId] = chart;
                chart.render();
            }

            function renderWeeklyTrend(trendData, rawData) {
                const options = {
                    series: [{
                        name: 'Nota Promedio',
                        type: 'line',
                        data: trendData.map(d => d.Nota_Promedio)
                    }, {
                        name: 'Volumen',
                        type: 'column',
                        data: trendData.map(d => d.Volumen)
                    }],
                    chart: {
                        height: 350,
                        type: 'line',
                        events: {
                            dataPointSelection: (event, chartContext, config) => {
                                const week = trendData[config.dataPointIndex].Fecha;
                                showDrillDownModalForWeek(week, rawData);
                            }
                        }
                    },
                    stroke: { width: [4, 0] },
                    title: { text: 'Nota Promedio vs Volumen de Auditorías' },
                    xaxis: { categories: trendData.map(d => d.Fecha) },
                    yaxis: [{
                        title: { text: 'Nota Promedio' },
                    }, {
                        opposite: true,
                        title: { text: 'Volumen' }
                    }]
                };
                renderChart('weekly-trend-chart', options);
            }
            
            function renderRootCause(causeData, rawData) {
                const options = {
                    series: [{
                        data: causeData.map(d => d.Frecuencia)
                    }],
                    chart: {
                        type: 'bar',
                        height: 350,
                         events: {
                            dataPointSelection: (event, chartContext, config) => {
                                const cause = causeData[config.dataPointIndex].Causa;
                                showDrillDownModalForCause(cause, rawData);
                            }
                        }
                    },
                    plotOptions: { bar: { borderRadius: 4, horizontal: true } },
                    dataLabels: { enabled: false },
                    xaxis: { categories: causeData.map(d => d.Causa) }
                };
                renderChart('root-cause-chart', options);
            }

            function renderAgentQuadrant(agentData, rawData) {
                const avgScore = agentData.reduce((sum, agent) => sum + agent.Nota_Promedio, 0) / agentData.length;
                const avgAudits = agentData.reduce((sum, agent) => sum + agent.Auditorias, 0) / agentData.length;

                const options = {
                    series: [{
                        name: 'Agentes',
                        data: agentData.map(agent => ({
                            x: agent.Auditorias,
                            y: agent.Nota_Promedio,
                            name: agent.Agente
                        }))
                    }],
                    chart: {
                        height: 350,
                        type: 'scatter',
                        zoom: { enabled: true, type: 'xy' },
                        events: {
                            dataPointSelection: (event, chartContext, config) => {
                                const agentName = agentData[config.dataPointIndex].Agente;
                                showDrillDownModalForAgent(agentName, rawData);
                            }
                        }
                    },
                    xaxis: {
                        tickAmount: 10,
                        title: { text: 'Volumen de Auditorías' }
                    },
                    yaxis: {
                        tickAmount: 7,
                        title: { text: 'Nota Promedio' }
                    },
                    annotations: {
                        yaxis: [{
                            y: avgScore,
                            borderColor: '#dc3545',
                            label: {
                                borderColor: '#dc3545',
                                style: { color: '#fff', background: '#dc3545' },
                                text: 'Promedio Nota'
                            }
                        }],
                        xaxis: [{
                            x: avgAudits,
                            borderColor: '#0d6efd',
                            label: {
                                borderColor: '#0d6efd',
                                style: { color: '#fff', background: '#0d6efd' },
                                text: 'Promedio Auditorías'
                            }
                        }]
                    },
                    tooltip: {
                        x: { formatter: (val) => `${val} Auditorías` },
                        y: { formatter: (val) => `Nota: ${val.toFixed(2)}` },
                        z: { title: 'Agente: ' }
                    }
                };
                renderChart('agent-quadrant', options);
            }

            function renderAgentTable(agentData, rawData) {
                const tableBody = document.getElementById('agent-table-body');
                agentData.sort((a, b) => b.Nota_Promedio - a.Nota_Promedio);
                tableBody.innerHTML = agentData.map(agent => `
                    <tr data-agent-name="${agent.Agente}">
                        <td>${agent.Agente}</td>
                        <td>${agent.Nota_Promedio.toFixed(2)}</td>
                        <td>${agent.Auditorias}</td>
                        <td>${agent.Errores_Criticos}</td>
                    </tr>
                `).join('');

                tableBody.querySelectorAll('tr').forEach(row => {
                    row.addEventListener('dblclick', () => {
                        const agentName = row.dataset.agentName;
                        showAgentDetailModal(agentName, agentData, rawData);
                    });
                });
            }
            
            function renderGenericBarChart(containerId, data, xField, yField, title, rawData, drillDownKey) {
                 data.sort((a, b) => b[yField] - a[yField]);
                 const options = {
                    series: [{ name: 'Nota Promedio', data: data.map(d => d[yField]) }],
                    chart: { 
                        type: 'bar', 
                        height: 350,
                        events: {
                            dataPointSelection: (event, chartContext, config) => {
                                const value = data[config.dataPointIndex][xField];
                                showDrillDownModalForGeneric(drillDownKey, value, rawData);
                            }
                        }
                    },
                    plotOptions: { bar: { horizontal: false } },
                    dataLabels: { enabled: false },
                    xaxis: { categories: data.map(d => d[xField]) },
                    title: { text: title }
                };
                renderChart(containerId, options);
            }

            function renderSkillPerformance(skillData, rawData) {
                renderGenericBarChart('skill-performance-chart', skillData, 'Skill', 'Nota_Promedio', 'Nota Promedio por Skill', rawData, 'Skill');
            }

            function renderSupervisorPerformance(supervisorData, rawData) {
                renderGenericBarChart('supervisor-performance-chart', supervisorData, 'Supervisor', 'Nota_Promedio', 'Nota Promedio por Supervisor', rawData, 'Supervisor');
            }
            
            function renderLongevityPerformance(longevityData, rawData) {
                renderGenericBarChart('longevity-performance-chart', longevityData, 'Longevidad', 'Nota_Promedio', 'Nota Promedio por Longevidad', rawData, 'Longevidad');
            }

            // --- LÓGICA DE MODALES (DRILL-DOWN) ---
            function showDrillDownModal(title, filteredData) {
                document.getElementById('drillDownModalLabel').textContent = title;
                const modalBody = document.getElementById('drillDownModalBody');
                
                if (!filteredData || filteredData.length === 0) {
                    modalBody.innerHTML = '<p>No hay datos para mostrar.</p>';
                    drillDownModal.show();
                    return;
                }

                const headers = ['Fecha', 'Agente', 'Supervisor', 'Skill', 'Nota', 'Error_Critico', 'Auditor', 'Comentarios'];
                let table = '<div class="table-responsive"><table class="table table-sm">';
                table += '<thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
                table += '<tbody>';
                filteredData.forEach(row => {
                    table += '<tr>';
                    headers.forEach(header => {
                        table += `<td>${row[header] || ''}</td>`;
                    });
                    table += '</tr>';
                });
                table += '</tbody></table></div>';
                modalBody.innerHTML = table;
                drillDownModal.show();
            }
            
            function showDrillDownModalForAgent(agentName, rawData) {
                const agentAudits = rawData.filter(d => d.Agente === agentName);
                showDrillDownModal(`Detalle de Auditorías para: ${agentName}`, agentAudits);
            }

            function showDrillDownModalForWeek(weekStartDate, rawData) {
                const start = new Date(weekStartDate);
                const end = new Date(start);
                end.setDate(start.getDate() + 7);
                const weekAudits = rawData.filter(d => {
                    const auditDate = new Date(d.Fecha);
                    return auditDate >= start && auditDate < end;
                });
                showDrillDownModal(`Detalle de Auditorías para la semana del ${weekStartDate}`, weekAudits);
            }
            
            function showDrillDownModalForCause(cause, rawData) {
                const causeAudits = rawData.filter(d => d.Causas_Raiz && d.Causas_Raiz.includes(cause));
                showDrillDownModal(`Auditorías con Causa Raíz: ${cause}`, causeAudits);
            }
            
            function showDrillDownModalForGeneric(key, value, rawData) {
                const filteredAudits = rawData.filter(d => d[key] === value);
                showDrillDownModal(`Auditorías para ${key}: ${value}`, filteredAudits);
            }

            function showAgentDetailModal(agentName, agentData, rawData) {
                const agentSummary = agentData.find(a => a.Agente === agentName);
                const agentAudits = rawData.filter(d => d.Agente === agentName);

                document.getElementById('drillDownModalLabel').textContent = `Ficha de Calidad: ${agentName}`;
                const modalBody = document.getElementById('drillDownModalBody');

                let content = `<h4>Resumen de Desempeño</h4>`;
                content += `<div class="row">
                    <div class="col-md-4"><strong>Nota Promedio:</strong> ${agentSummary.Nota_Promedio.toFixed(2)}</div>
                    <div class="col-md-4"><strong>Total Auditorías:</strong> ${agentSummary.Auditorias}</div>
                    <div class="col-md-4"><strong>Errores Críticos:</strong> ${agentSummary.Errores_Criticos}</div>
                </div><hr>`;
                
                content += `<h4>Historial de Auditorías</h4>`;
                
                const headers = ['Fecha', 'Nota', 'Error_Critico', 'Auditor', 'Comentarios'];
                content += '<div class="table-responsive"><table class="table table-sm">';
                content += '<thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
                content += '<tbody>';
                agentAudits.forEach(row => {
                    content += '<tr>';
                    headers.forEach(header => {
                        content += `<td>${row[header] || ''}</td>`;
                    });
                    content += '</tr>';
                });
                content += '</tbody></table></div>';

                modalBody.innerHTML = content;
                drillDownModal.show();
            }
        });
    </script>
</body>
</html>
